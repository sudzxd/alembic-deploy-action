name: Validate Published Action

on:
  release:
    types: [published]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  validate-dry-run:
    name: Validate Dry-Run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Safe Migration
        id: safe
        uses: sudzxd/alembic-deploy-action@v1
        with:
          database-url: sqlite:///test.db
          dry-run: true
          working-directory: tests/test_app
          revision: "002"
          analyze-safety: true

      - name: Verify Safe Result
        run: |
          [[ "${{ steps.safe.outputs.migration-status }}" == "dry-run" ]] || exit 1
          [[ "${{ steps.safe.outputs.is-safe }}" == "true" ]] || exit 1

      - name: Test Dangerous Migration
        id: danger
        uses: sudzxd/alembic-deploy-action@v1
        with:
          database-url: sqlite:///test.db
          dry-run: true
          working-directory: tests/test_app
          revision: "003"
          analyze-safety: true
          fail-on-danger: false

      - name: Verify Danger Detection
        run: |
          [[ "${{ steps.danger.outputs.is-safe }}" == "false" ]] || exit 1

  validate-execution:
    name: Validate Execution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply Migration
        uses: sudzxd/alembic-deploy-action@v1
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          revision: "001"

      - name: Verify Revision
        id: check
        uses: sudzxd/alembic-deploy-action@v1
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: current

      - name: Validate
        run: |
          [[ "${{ steps.check.outputs.current-revision }}" == "001" ]] || exit 1

  validate-v1-tag:
    name: Validate v1 Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test with v1
        uses: sudzxd/alembic-deploy-action@v1
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: current

  validate-v1-0-0-tag:
    name: Validate v1.0.0 Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test with v1.0.0
        uses: sudzxd/alembic-deploy-action@v1.0.0
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: current

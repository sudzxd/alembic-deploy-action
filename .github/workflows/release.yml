name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Tag (e.g. v1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as Pre-release'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" \
            --title "${{ inputs.version }}" \
            --generate-notes \
            --prerelease="${{ inputs.prerelease }}" \
            --target "${{ github.sha }}"

      - name: Update Major Version Tag
        if: ${{ !inputs.prerelease }}
        run: |
          # Extract major version (e.g., v1 from v1.2.3)
          MAJOR_TAG=$(echo "${{ inputs.version }}" | sed -E 's/^(v[0-9]+).*/\1/')
          
          echo "Updating floating tag: $MAJOR_TAG -> ${{ inputs.version }}"
          
          # Force update the major version tag to point to this commit
          git tag -fa "$MAJOR_TAG" -m "Update $MAJOR_TAG to ${{ inputs.version }}"
          git push origin "$MAJOR_TAG" --force

name: Test Action

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  test-dry-run:
    name: Test Dry-Run Mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Test dry-run with safe migration
        id: safe_preview
        uses: ./
        with:
          database-url: sqlite:///test.db
          dry-run: true
          working-directory: tests/test_app
          alembic-config: alembic.ini
          revision: "002"
          analyze-safety: true

      - name: Display safe migration results
        run: |
          echo "Status: ${{ steps.safe_preview.outputs.migration-status }}"
          echo "Current: ${{ steps.safe_preview.outputs.current-revision }}"
          echo "Target: ${{ steps.safe_preview.outputs.target-revision }}"
          echo "Is Safe: ${{ steps.safe_preview.outputs.is-safe }}"

      - name: Test dry-run with dangerous migration
        id: danger_preview
        uses: ./
        with:
          database-url: sqlite:///test.db
          dry-run: true
          working-directory: tests/test_app
          alembic-config: alembic.ini
          revision: "003"
          analyze-safety: true
          fail-on-danger: false

      - name: Display dangerous migration results
        run: |
          echo "Status: ${{ steps.danger_preview.outputs.migration-status }}"
          echo "Is Safe: ${{ steps.danger_preview.outputs.is-safe }}"

      - name: Verify warnings were detected
        run: |
          if [ "${{ steps.danger_preview.outputs.is-safe }}" = "true" ]; then
            echo "ERROR: Dangerous migration was marked as safe"
            exit 1
          fi
          echo "SUCCESS: Dangerous operations detected correctly"

  test-migration-execution:
    name: Test Migration Execution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Apply initial migration
        uses: ./
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          alembic-config: alembic.ini
          revision: "001"

      - name: Check current revision
        id: check_rev
        uses: ./
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          alembic-config: alembic.ini
          command: current

      - name: Verify migration applied
        run: |
          echo "Current revision: ${{ steps.check_rev.outputs.current-revision }}"
          if [ "${{ steps.check_rev.outputs.current-revision }}" != "001" ]; then
            echo "ERROR: Migration not applied correctly"
            exit 1
          fi
          echo "SUCCESS: Migration applied correctly"

  test-all-commands:
    name: Test All Alembic Commands
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Test upgrade command
        uses: ./
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: upgrade
          revision: "001"

      - name: Test current command
        uses: ./
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: current

      - name: Test history command
        uses: ./
        with:
          database-url: sqlite:///test.db
          working-directory: tests/test_app
          command: history
